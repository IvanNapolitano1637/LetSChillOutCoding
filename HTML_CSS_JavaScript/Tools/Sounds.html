<!DOCTYPE html>
<html lang="en"><!--T02#010 - Fabio - Sounds-->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Sounds</title>
		<style>
			body { background: #BFBFFF; }
			output { background: #FFFF7F; }
			button { background-color: #FFBFBF; }

			#frequencyRange { width: 1400px; }
			@media (max-width: 600px) { #frequencyRange { width: 250px; } }

			#keyboard {
				display: flex;
				justify-content: flex-start;
				position: relative;
				height: 200px;
			}

			#keyboard button.white {
				flex: 0 0 50px;
				height: 200px;
				display: flex;
				flex-direction: column;
				justify-content: flex-end;
				align-items: center;
				user-select: none;
				background-color: #FFFFBF;
				z-index: 1;
				position: relative;
				border: 1px solid #999;
				box-sizing: border-box;
				transition: transform 0.05s;
			}

			#keyboard button.black {
				width: 35px;
				height: 120px;
				background-color: #BFBFBF;
				position: absolute;
				top: 0;
				z-index: 2;
				border: 1px solid #666;
				box-sizing: border-box;
				transition: transform 0.05s;
			}

			#keyboard button#Csharp4 { left: 35px; }
			#keyboard button#Dsharp4 { left: 85px; }
			#keyboard button#Fsharp4 { left: 185px; }
			#keyboard button#Gsharp4 { left: 235px; }
			#keyboard button#Asharp4 { left: 285px; }

			#keyboard button.white:active,
			#keyboard button.white.pressed { transform: translateY(4px); }
			#keyboard button.black:active,
			#keyboard button.black.pressed { transform: translateY(4px); }
		</style>
	</head>
	<body>

	<input type="radio" id="sine" name="oscillatorType" value="sine" onchange="setOscillatorType()" checked />
	<output>sine</output>
	<input type="radio" id="sawtooth" name="oscillatorType" value="sawtooth" onchange="setOscillatorType()"/>
	<output>sawtooth</output>
	<input type="radio" id="square" name="oscillatorType" value="square" onchange="setOscillatorType()"/>
	<output>square</output>
	<input type="radio" id="triangle" name="oscillatorType" value="triangle" onchange="setOscillatorType()"/>
	<output>triangle</output><br><br>

	<b><output id="FREQUENCY_VALUE"></output></b><br><br>
	<b><output id="FREQUENCY_MIN_VALUE"></output></b>
	<input type="range" id="frequencyRange" name="frequency" oninput="setFrequency()"/>
	<b><output id="FREQUENCY_MAX_VALUE"></output></b><br><br>

	<button id="halveMax" onclick="halveMax()">SmallerMax</button><br>

	<input type="radio" id="50" name="maxFrequency" value="50" onchange="setMaxFrequency()" disabled />50<br>
	<input type="radio" id="100" name="maxFrequency" value="100" onchange="setMaxFrequency()" disabled />100<br>
	<input type="radio" id="200" name="maxFrequency" value="200" onchange="setMaxFrequency()" disabled />200<br>
	<input type="radio" id="500" name="maxFrequency" value="500" onchange="setMaxFrequency()"/>500<br>
	<input type="radio" id="1000" name="maxFrequency" value="1000" onchange="setMaxFrequency()" checked />1000<br>
	<input type="radio" id="2000" name="maxFrequency" value="2000" onchange="setMaxFrequency()"/>2000<br>
	<input type="radio" id="4000" name="maxFrequency" value="4000" onchange="setMaxFrequency()"/>4000<br>
	<input type="radio" id="8000" name="maxFrequency" value="8000" onchange="setMaxFrequency()"/>8000<br>
	<input type="radio" id="16000" name="maxFrequency" value="16000" onchange="setMaxFrequency()"/>16000<br>
	<input type="radio" id="24000" name="maxFrequency" value="24000" onchange="setMaxFrequency()"/>24000<br>

	<button id="doubleMax" onclick="doubleMax()">BiggerMax</button><br><br>

	<button id="play" onclick="play()">Play</button>
	<button id="stop" onclick="stop()">Stop</button>

	<button id="halveFrequency" onclick="multiplyFREQUENCY_VALUE(0.5)">Halve frequency</button>
	<button id="doubleFrequency" onclick="multiplyFREQUENCY_VALUE(2)">Double frequency</button><br><br>

	<input type="radio" id="s0" name="sirenType" onchange="changeSirenType(800, 1200, 300);" checked /><output>I</output>
	<input type="radio" id="s1" name="sirenType" onchange="changeSirenType(300, 600, 500);"/><output>II</output>
	<input type="radio" id="s2" name="sirenType" onchange="changeSirenType(1900, 2300, 50);"/><output>III</output>
	<input type="radio" id="s3" name="sirenType" onchange="changeSirenType(466, 622, 750);"/><output>IV</output>
	<input type="radio" id="s4" name="sirenType" onchange="changeSirenType(466, 622, 550);"/><output>V</output>
	<input type="radio" id="s5" name="sirenType" onchange="changeSirenType(1200, 1600, 500);"/><output>VI</output><br>
	<button id="sirenOn" onclick="sirenOn()">Siren On</button>
	<button id="sirenOff" onclick="sirenOff()">Siren Off</button><br><br>

	<div id="keyboard">
		<button class="white" id="C4">C4</button>
		<button class="white" id="D4">D4</button>
		<button class="white" id="E4">E4</button>
		<button class="white" id="F4">F4</button>
		<button class="white" id="G4">G4</button>
		<button class="white" id="A4">A4</button>
		<button class="white" id="B4">B4</button>
		<button class="white" id="C5">C5</button>

		<button class="black" id="Csharp4">C#4</button>
		<button class="black" id="Dsharp4">D#4</button>
		<button class="black" id="Fsharp4">F#4</button>
		<button class="black" id="Gsharp4">G#4</button>
		<button class="black" id="Asharp4">A#4</button>
	</div>

	<script>
		//SULLE SIRENE HO ANCORA DA RAGIONARE
		const FREQUENCY_VALUE = document.querySelector("#FREQUENCY_VALUE");
		const FREQUENCY_INPUT = document.querySelector("#frequencyRange");
		const FREQUENCY_MAX_VALUE = document.querySelector("#FREQUENCY_MAX_VALUE");
		const FREQUENCY_MIN_VALUE = document.querySelector("#FREQUENCY_MIN_VALUE");
		const MAX_FREQUENCY_VALUE = [50,100,200,500,1000,2000,4000,8000,16000,24000];
		const MAX_FREQUENCY_ELEMENT = document.getElementsByName("maxFrequency");
		const OSCILLATOR_TYPE_ELEMENT = document.getElementsByName("oscillatorType");

		let audioContext;
		let oscillator = null;
		let oscillatorNotes = null;
		let oscillatorSiren = null;
		let gain;
		let interval;
		let oscillatorinputType = "sine";
		let frequencyHz = 440;
		let soundOn = false;
		let sirenSoundOn = false;
		let indexArray = 4;
		let sirenMinFrequency = 800;
		let sirenMaxFrequency = 1200;
		let duration = 200;

		FREQUENCY_MIN_VALUE.textContent = "0 Hz";
		FREQUENCY_MAX_VALUE.textContent = MAX_FREQUENCY_VALUE[indexArray] + " Hz";
		FREQUENCY_INPUT.min = 0;
		FREQUENCY_INPUT.max = MAX_FREQUENCY_VALUE[indexArray];
		FREQUENCY_INPUT.step = 1;
		FREQUENCY_INPUT.value = frequencyHz;
		FREQUENCY_VALUE.textContent = frequencyHz + " Hz";

		function updateMaxFrequencyOptions(){
			for(let i=0;i<MAX_FREQUENCY_ELEMENT.length;i++){
				MAX_FREQUENCY_ELEMENT[i].disabled = frequencyHz > MAX_FREQUENCY_VALUE[i];
			}
		}

		function setFrequency(){
			frequencyHz = parseInt(FREQUENCY_INPUT.value);
			FREQUENCY_VALUE.textContent = frequencyHz+" Hz";
			if(oscillator){
				oscillator.frequency.setValueAtTime(frequencyHz,audioContext.currentTime);
			}
			updateMaxFrequencyOptions();
		}

		function playSound(type,freq){
			if(!audioContext){
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
			}
			if(oscillator){
				oscillator.stop();
			}
			oscillator = audioContext.createOscillator();
			oscillator.type = type;
			oscillator.frequency.setValueAtTime(freq,audioContext.currentTime);
			oscillator.connect(audioContext.destination);
			oscillator.start();
			soundOn = true;
		}

		function play(){
			playSound(oscillatorinputType,frequencyHz);
		}

		function stop(){
			if(oscillator){
				oscillator.stop();
				oscillator = null;
			}
			soundOn = false;
		}

		function multiplyFREQUENCY_VALUE(mult){
			let newFreq = Math.round(frequencyHz*mult);
			if(newFreq >= 0 && newFreq <= 24000){
				frequencyHz = newFreq;
				FREQUENCY_INPUT.value = frequencyHz;
				FREQUENCY_VALUE.textContent = frequencyHz + " Hz";
				updateMaxFrequencyOptions();
				if(soundOn){
					playSound(oscillatorinputType,frequencyHz);
				}
			}
		}

		function setOscillatorType(){
			for(let el of OSCILLATOR_TYPE_ELEMENT){
				if(el.checked){
					oscillatorinputType = el.value;
				}
			}
			if(soundOn){
				playSound(oscillatorinputType,frequencyHz);
			}
		}

		function playNote(freq){
			if(!audioContext){
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
			}
			stopNote();
			oscillatorNotes = audioContext.createOscillator();
			oscillatorNotes.type = "sine";
			oscillatorNotes.frequency.setValueAtTime(parseFloat(freq),audioContext.currentTime);
			oscillatorNotes.connect(audioContext.destination);
			oscillatorNotes.start();
		}

		function stopNote(){
			if(oscillatorNotes){
				oscillatorNotes.stop();oscillatorNotes = null;
			}
		}

		function halveMax(){
			if(indexArray > 0 && frequencyHz <= MAX_FREQUENCY_VALUE[indexArray - 1]){
				indexArray--;
				FREQUENCY_INPUT.max = MAX_FREQUENCY_VALUE[indexArray];
				MAX_FREQUENCY_ELEMENT[indexArray].checked = true;
				FREQUENCY_MAX_VALUE.textContent = MAX_FREQUENCY_VALUE[indexArray] + " Hz";
			}
		}

		function doubleMax(){
			if(indexArray < MAX_FREQUENCY_VALUE.length - 1){
				indexArray++;
				FREQUENCY_INPUT.max = MAX_FREQUENCY_VALUE[indexArray];
				MAX_FREQUENCY_ELEMENT[indexArray].checked = true;
				FREQUENCY_MAX_VALUE.textContent = MAX_FREQUENCY_VALUE[indexArray] + " Hz";
			}
		}

		function setMaxFrequency(){
			for(let i = 0; i < MAX_FREQUENCY_ELEMENT.length; i++){
				if(MAX_FREQUENCY_ELEMENT[i].checked){
					indexArray = i;
					FREQUENCY_INPUT.max = MAX_FREQUENCY_VALUE[i];
					FREQUENCY_MAX_VALUE.textContent = MAX_FREQUENCY_VALUE[i] + " Hz";
				}
			}
		}

		function sirenOn(){
			if(!audioContext){
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
			}
			if(oscillatorSiren){
				oscillatorSiren.stop();
			}
			oscillatorSiren = audioContext.createOscillator();
			gain = audioContext.createGain();
			oscillatorSiren.type = "sine";
			oscillatorSiren.frequency.setValueAtTime(sirenMinFrequency,audioContext.currentTime);
			oscillatorSiren.connect(gain);
			gain.connect(audioContext.destination);
			gain.gain.setValueAtTime(0.5,audioContext.currentTime);
			oscillatorSiren.start();
			interval = setInterval(()=>{
				let freq = oscillatorSiren.frequency.value === sirenMinFrequency ? sirenMaxFrequency : sirenMinFrequency;
				oscillatorSiren.frequency.setValueAtTime(freq,audioContext.currentTime);
			}, duration);
			sirenSoundOn = true;
		}

		function sirenOff(){
			if(oscillatorSiren){
				oscillatorSiren.stop();
				clearInterval(interval);
				sirenSoundOn = false;
			}
		}

		function changeSirenType(min,max,dur){
			let flag = sirenSoundOn;
			if(flag){
				sirenOff();
			}
			sirenMinFrequency = min;
			sirenMaxFrequency = max;
			duration = dur;
			if(flag){
				sirenOn();
			}
		}

		const keyMap = {
			"a":"C4",
			"w":"Csharp4",
			"s":"D4",
			"e":"Dsharp4",
			"d":"E4",
			"f":"F4",
			"t":"Fsharp4",
			"g":"G4",
			"y":"Gsharp4",
			"h":"A4",
			"u":"Asharp4",
			"j":"B4",
			"k":"C5"
		};

		const freqMap = {
			"C4":261.626,
			"Csharp4":277.183,
			"D4":293.665,
			"Dsharp4":311.127,
			"E4":329.628,
			"F4":349.228,
			"Fsharp4":369.994,
			"G4":391.995,
			"Gsharp4":415.305,
			"A4":440,
			"Asharp4":466.164,
			"B4":493.883,
			"C5":523.251
		};

		document.addEventListener("keydown", e=>{
			let key = e.key.toLowerCase();
			if(key in keyMap){
				const btn = document.getElementById(keyMap[key]);
				if(btn && !btn.classList.contains("pressed")){
					btn.classList.add("pressed"); 
					playNote(freqMap[btn.id]);
				}
			} else if(key === "l"){
				if(sirenSoundOn) sirenOff(); else sirenOn();
			}
		});

		document.addEventListener("keyup", e=>{
			let key = e.key.toLowerCase();
			if(key in keyMap){
				const btn = document.getElementById(keyMap[key]);
				if(btn) btn.classList.remove("pressed");
				stopNote();
			}
		});

		document.querySelectorAll("#keyboard button").forEach(btn=>{
			btn.addEventListener("mousedown", ()=>{ btn.classList.add("pressed"); playNote(freqMap[btn.id]); });
			btn.addEventListener("mouseup", ()=>{ btn.classList.remove("pressed"); stopNote(); });
			btn.addEventListener("mouseleave", ()=>{ btn.classList.remove("pressed"); stopNote(); });
			btn.addEventListener("touchstart", e=>{ e.preventDefault(); btn.classList.add("pressed"); playNote(freqMap[btn.id]); }, {passive:false});
			btn.addEventListener("touchend", ()=>{ btn.classList.remove("pressed"); stopNote(); });
		});
	</script>
	</body>
</html>