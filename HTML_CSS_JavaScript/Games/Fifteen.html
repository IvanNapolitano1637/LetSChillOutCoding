<!DOCTYPE HTML>
<html lang="en"><!--G06#016 - Serena - Fifteen-->
	<head>
		<title>Fifteen Puzzle</title>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="ie=edge">
		<style>
			body {
				margin: 0;
				padding: 20px;
				display: flex;
				justify-content: center;
				align-items: flex-start;
				min-height: 100vh;
				font-family: 'Segoe UI', Arial, sans-serif;
				overflow-x: hidden;
				-webkit-tap-highlight-color: transparent; 
			}
			#Fifteen {
				position: relative;
				user-select: none;
				-webkit-user-select: none;
			}
			canvas {
				display: block;
			}
			.tile-container {
				position: absolute;
				display: flex;
				justify-content: center;
				align-items: center;
				pointer-events: none;
				z-index: 1;
			}
		</style>
	</head>

	<body id="body">
		<div id="Fifteen">
			<canvas id="board">
				Upgrade Browser
			</canvas>
		</div>

		<script>
			const COLOR_1 = "#a7ffa7";
			const COLOR_2 = "#efefef";
			const BACKGROUND_COLOR = "#af67df";
			const FRAME_COLOR = "#000000";
			const BORDER_COLOR = "#ff9f00";
			const WINNING_COLOR = "#00ff00";
			const DESKTOP = !(/Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i).test(navigator.userAgent);
			const UNIT = DESKTOP ? 5 : 3;
			const DIVISION_WIDTH = UNIT;
			const BORDER_WIDTH = 4*UNIT;
			const MARGIN_DIM = 2*UNIT;
			const SIDE = 20*UNIT;
			const IDS = ["1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "0"];
			const ORIZONTAL_CONST = DIVISION_WIDTH + BORDER_WIDTH + MARGIN_DIM;
			const WIDTH = (ORIZONTAL_CONST + MARGIN_DIM + (4*SIDE) + (5*DIVISION_WIDTH) + (2*BORDER_WIDTH));
			const HEIGHT = (2*MARGIN_DIM + (4*SIDE) + (5*DIVISION_WIDTH) + (2*BORDER_WIDTH));
			let cursorX, cursorY, r1 = 3, c1 = 3, counterMoves = 0, gameFinished, begun = false, isSolving = false;

			drawBoard();

			function drawBoard(){
				document.body.style.background = BACKGROUND_COLOR;
				const container = document.getElementById("Fifteen");
				for(let i = 0; i < 16; i++){
					const div = document.createElement("div");
					div.id = IDS[i];
					div.className = "tile-container";
					div.style.width = SIDE + "px";
					div.style.height = SIDE + "px";
					div.style.fontSize = `${UNIT*0.75}rem`;
					div.style.fontWeight = "bold";
					container.appendChild(div);
				}
				let board = document.getElementById("board");
				board.width = WIDTH; 
				board.height = HEIGHT;
				if(board.getContext("2d")){
					let ctx = board.getContext("2d");
					ctx.fillStyle = BORDER_COLOR;
					ctx.fillRect(ORIZONTAL_CONST + MARGIN_DIM, MARGIN_DIM, (SIDE*4) + (DIVISION_WIDTH*5) + (BORDER_WIDTH*2), (SIDE*4) + (DIVISION_WIDTH*5) + (BORDER_WIDTH*2));
					ctx.fillStyle = FRAME_COLOR;
					ctx.fillRect(ORIZONTAL_CONST + MARGIN_DIM + BORDER_WIDTH, MARGIN_DIM + BORDER_WIDTH, (SIDE*4) + (DIVISION_WIDTH*5), (SIDE*4) + (DIVISION_WIDTH*5));
				}
				const handleInput = (e) => {
					const rect = board.getBoundingClientRect();
					const clientX = e.touches ? e.touches[0].clientX : e.clientX;
					const clientY = e.touches ? e.touches[0].clientY : e.clientY;
					cursorX = clientX - rect.left;
					cursorY = clientY - rect.top;
					select();
				};
				board.onclick = handleInput;
				board.ontouchstart = (e) => {
					handleInput(e); e.preventDefault();
				};
				createButtons();
				shuffleTiles();
			}

			function createButtons(){
				const oldContainer = document.getElementById("controls");
				if(oldContainer){
					oldContainer.remove();
				}
				const container = document.createElement("div");
				container.id = "controls";
				const boardWidth = (SIDE*4) + (DIVISION_WIDTH*5) + (BORDER_WIDTH*2);
				const boardStartX = ORIZONTAL_CONST + MARGIN_DIM;
				const boardBottomY = MARGIN_DIM + boardWidth;
				container.style.cssText = `
					position: absolute;
					display: flex;
					justify-content: space-between;
					gap: ${UNIT}px;
					left: ${boardStartX}px; 
					top: ${boardBottomY + (UNIT*5)}px; 
					width: ${boardWidth}px;
					z-index: 10;
					box-sizing: border-box;
				`;
				const btnData = [
					{id: "shuffleBtn", txt: "Shuffle", click: "shuffleTiles()"},
					{id: "restartBtn", txt: "Restart", click: "restart()"},
					{id: "solveBtn", txt: "Solve", click: "solve()"}
				];
				btnData.forEach(b => {
					let btn = document.createElement("button");
					btn.id = b.id;
					btn.style.cssText = `
						flex: 1;
						padding: ${UNIT*1.5}px 0;
						font-size: ${UNIT*3.2}px;
						font-family: 'Segoe UI', Arial, sans-serif;
						font-weight: 800;
						cursor: pointer;
						background: rgba(179, 229, 252, 0.9);
						color: #333;
						border: ${UNIT/3}px solid ${BORDER_COLOR};
						border-radius: 12px;
						text-transform: uppercase;
						box-shadow: 0px ${UNIT/2}px 0px rgba(0,0,0,0.1);
						transition: all 0.2s;
					`;
					btn.setAttribute("onclick", b.click);
					btn.innerHTML = b.txt;
					btn.onmouseover = () => {
						btn.style.background = BORDER_COLOR;
						btn.style.color = "#fff";
					};
					btn.onmouseout = () => {
						btn.style.background = "rgba(179, 229, 252, 0.9)";
						btn.style.color = "#333";
					};
					btn.onmousedown = () => {
						btn.style.transform = "translateY(2px)";
						btn.style.boxShadow = "0px 0px 0px rgba(0,0,0,0.1)";
					};
					btn.onmouseup = () => {
						btn.style.transform = "translateY(0px)";
						btn.style.boxShadow = `0px ${UNIT/2}px 0px rgba(0,0,0,0.1)`;
					};
					container.appendChild(btn);
				});
				document.getElementById("Fifteen").appendChild(container);
			}

			function drawTile(row, column, tile){
				let val = parseInt(tile, 16);
				let board = document.getElementById("board");
				let ctx = board.getContext("2d");
				let color = (tile === "0") ? BORDER_COLOR : (((val + Math.floor((val - 1)/4))%2 === 1) ? COLOR_1 : COLOR_2);
				let posX = ORIZONTAL_CONST + BORDER_WIDTH + DIVISION_WIDTH + MARGIN_DIM + (column*(SIDE + DIVISION_WIDTH));
				let posY = BORDER_WIDTH + DIVISION_WIDTH + MARGIN_DIM + (row*(SIDE + DIVISION_WIDTH));
				ctx.fillStyle = color;
				ctx.fillRect(posX, posY, SIDE, SIDE);
				let targetId = ((row*4 + column + 1)%16).toString(16);
				const el = document.getElementById(targetId);
				if(el){
					el.textContent = (tile === "0") ? "" : val;
					el.style.left = posX + "px";
					el.style.top = posY + "px";
				}
			}

			function swapTiles(t1, t2){
				const el1 = document.getElementById(t1), el2 = document.getElementById(t2);
				let v1 = el1.textContent, v2 = el2.textContent;
				let idx1 = (parseInt(t1, 16) + 15)%16, idx2 = (parseInt(t2, 16) + 15)%16;
				drawTile(Math.floor(idx1/4), idx1%4, (v2 === "" ? "0" : parseInt(v2).toString(16)));
				drawTile(Math.floor(idx2/4), idx2%4, (v1 === "" ? "0" : parseInt(v1).toString(16)));
				begun = true;
			}

			function select(){
				if(gameFinished || isSolving){
					return;
				}
				let r = Math.floor((cursorY - (BORDER_WIDTH + DIVISION_WIDTH + MARGIN_DIM))/(SIDE + DIVISION_WIDTH));
				let c = Math.floor((cursorX - (ORIZONTAL_CONST + BORDER_WIDTH + DIVISION_WIDTH + MARGIN_DIM))/(SIDE + DIVISION_WIDTH));
				if(r >= 0 && r < 4 && c >= 0 && c < 4 && (Math.abs(r - r1) + Math.abs(c - c1)) === 1){
					swapTiles(((4*r + c + 1)%16).toString(16), ((4*r1 + c1 + 1)%16).toString(16));
					r1 = r;
					c1 = c;
					counterMoves++;
					if(begun && checkWin()){
						gameFinished = true;
						document.body.style.background = WINNING_COLOR;
						setTimeout(() => alert("Solved in " + counterMoves + " moves!"), 100);
					}
				}
			}

			function checkWin(){
				for(let i = 0; i < 15; i++){
					if(document.getElementById(((i + 1)%16).toString(16)).textContent !== String(i + 1)){
						return false;
					}
				}
				return true;
			}

			function shuffleTiles(){
				gameFinished = false;
				document.body.style.background = BACKGROUND_COLOR;
				let s = "123456789abcdef0".split('');
				do{
					for(let i = s.length - 1; i > 0; i--){
						const j = Math.floor(Math.random()*(i + 1));
						[s[i], s[j]] = [s[j], s[i]];
					}
				}while(!isSolvable(s));
				s.forEach((id, i) => drawTile(Math.floor(i/4), i%4, id));
				let zIdx = s.indexOf("0");
				r1 = Math.floor(zIdx/4); c1 = zIdx%4;
				counterMoves = 0; begun = false;
			}

			function isSolvable(a){
				let inv = 0, zR = 0;
				for(let i = 0; i < 16; i++){
					if(a[i] === "0"){
						zR = Math.floor(i/4);
						continue;
					}
					for(let j = i + 1; j < 16; j++){
						inv += (a[j] !== "0" && parseInt(a[i], 16) > parseInt(a[j], 16)) ? 1 : 0;
					}
				}
				return (zR%2 === 0) ? (inv%2 !== 0) : (inv%2 === 0);
			}

			function restart(){
				window.location.reload();
			}

			function solve(){
				if(isSolving || gameFinished){
					return;
				}
				const btn = document.getElementById("solveBtn");
				btn.innerHTML = "Wait...";
				btn.disabled = true;
				isSolving = true;
				let state = [];
				for(let i = 0; i < 16; i++){
					let val = document.getElementById(((i + 1)%16).toString(16)).textContent;
					state.push(val === "" ? 0 : parseInt(val));
				}
				setTimeout(() => {
					let path = getFastPath(state);
					if(path){
						animate(path);
					}else{
						alert("Too complex...");
						resetUI();
					}
				}, 50);
			}

			function getHeuristic(s){
				let d = 0;
				for(let i = 0; i < 16; i++){
					if(s[i] === 0){
						continue;
					}
					d += Math.abs(Math.floor(i/4) - Math.floor((s[i] - 1)/4)) + Math.abs((i%4) - ((s[i] - 1)%4));
				}
				return d;
			}

			function getFastPath(state){
				let bound = getHeuristic(state);
				let path = [], startTime = Date.now();
				while(Date.now() - startTime < 3000){
					let t = search(state, 0, bound, path, state.indexOf(0), "");
					if(t === "FOUND"){
						return path;
					}
					bound = t + 2;
				}
				return null;
			}

			function search(s, g, bound, path, z, prev){
				let h = getHeuristic(s);
				if(g + h*1.5 > bound){
					return g + h*1.5;
				}
				if(h === 0){
					return "FOUND";
				}
				let min = Infinity, r = Math.floor(z/4), c = z%4;
				let moves = [];
				if(r > 0 && prev !== "D"){
					moves.push({d: "U", i: z - 4 });
				}
				if(r < 3 && prev !== "U"){
					moves.push({d: "D", i: z + 4 });
				}
				if(c > 0 && prev !== "R"){
					moves.push({d: "L", i: z - 1 });
				}
				if(c < 3 && prev !== "L"){
					moves.push({d: "R", i: z + 1 });
				}
				for(let m of moves){
					[s[z], s[m.i]] = [s[m.i], s[z]];
					path.push(m.d);
					let t = search(s, g + 1, bound, path, m.i, m.d);
					if(t === "FOUND"){
						return "FOUND";
					}
					if(t < min){
						min = t;
					}
					path.pop();
					[s[z], s[m.i]] = [s[m.i], s[z]];
				}
				return min;
			}

			function animate(moves){
				let i = 0;
				let timer = setInterval(() => {
					if(i >= moves.length){
						clearInterval(timer);
						gameFinished = true;
						document.body.style.background = WINNING_COLOR;
						resetUI();
						setTimeout(() => alert("Solved in " + counterMoves + " moves!"), 50);
						return;
					}
					let zIdx = r1*4 + c1, tIdx = zIdx + (moves[i] === "U" ? -4 : moves[i] === "D" ? 4 : moves[i] === "L" ? -1 : 1);
					swapTiles(((tIdx + 1)%16).toString(16), ((zIdx + 1)%16).toString(16));
					r1 = Math.floor(tIdx/4);
					c1 = tIdx%4;
					counterMoves++;
					i++;
				}, 180);
			}

			function resetUI(){
				isSolving = false;
				document.getElementById("solveBtn").innerHTML = "Solve";
				document.getElementById("solveBtn").disabled = false;
			}
		</script>
	</body>
</html>