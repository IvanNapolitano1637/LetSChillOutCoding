<!DOCTYPE html>
<html lang="en"><!--G07#019 - Filippo - Chess-->
	<head>
		<meta charset="UTF-8">
		<title>Chess</title>
		<style>
			:root{
				--bg: #2c3e50;
				--light: #f0d9b5;
				--dark: #b58863;
				--sel: #769656;
				--last-move: rgba(255, 255, 0, 0.4);
				--capture-flash: #e74c3c;
			}
			body{
				font-family: 'Segoe UI', sans-serif;
				background: var(--bg);
				color: white;display: flex;
				flex-direction: column;
				align-items: center;
				padding: 20px;
			}
			.main-container{
				display: flex;
				gap: 20px;
				flex-wrap: wrap;
				justify-content: center;
			}
			.board{
				display: grid;
				grid-template-columns: repeat(8, 60px);
				grid-template-rows: repeat(8, 60px);
				border: 8px solid #34495e;
				box-shadow: 0 10px 30px rgba(0,0,0,0.5);
			}
			.square{
				width: 60px;
				height: 60px;
				display: flex;
				justify-content: center;
				align-items: center;
				font-size: 45px;
				cursor: pointer;
				user-select: none;
				position: relative;
				transition: background 0.2s;
			}
			.light{
				background-color: var(--light);
			}
			.dark{
				background-color: var(--dark);
			}
			.selected{
				background-color: var(--sel) !important;
			}
			.last-move{
				background-color: var(--last-move) !important;
			}
			.in-check{
				background-color: #e74c3c !important;
			}
			.flash-red{
				animation: flash 0.5s;
			}
			@keyframes flash{
				0%{
					background: var(--capture-flash);
				}100%{
				}
			}
			.legal-dot::after{
				content: '';
				width: 20px;
				height: 20px;
				background-color: #27ae60;
				border-radius: 50%;
				position: absolute;
				opacity: 0.8;
			}
			.capture-mark{
				background-color: rgba(39, 174, 96, 0.4) !important;
				border: 4px solid #27ae60;
				box-sizing: border-box;
			}
			.game-layout{
				display: flex;
				gap: 20px;
				align-items: flex-start;
				margin-top: 10px;
			}
			.info-panel{
				width: 250px;
				height: 496px;
				background: #34495e;
				padding: 15px;
				border-radius: 8px;
				text-align: left;
				overflow-y: auto;
				box-sizing: border-box;
				display: none;
			}
			.status{
				font-size: 1.2rem;
				margin-bottom: 15px;
				color: #f1c40f;
				font-weight: bold;
			}
			.log-entry{
				font-size: 0.9rem;
				border-bottom: 1px solid #456789;
				padding: 5px 0;
				color: #ecf0f1;
			}
			button{
				margin-top: 20px;
				padding: 10px 20px;
				cursor: pointer;
				background: #27ae60;
				color: white;
				border: none;
				border-radius: 5px;
			}
			#logContainer{
				display: none;
			}
		</style>
	</head>
	<body>
		<h1>Chess</h1>
		<div id="status" class="status">White has to begin.</div>
		<div style="margin-bottom: 15px;">
			<input type="checkbox" id="toggleLog" onclick="toggleLog()">
			<label for="toggleLog" style="cursor:pointer; font-size: 0.9rem;"> Show Log Moves</label>
		</div>
		<div class="game-layout">
			<div id="board" class="board"></div>
			<div class="info-panel" id="logContainer">
				<div style="font-weight: bold; border-bottom: 2px solid #f1c40f; margin-bottom: 10px;">LOG MOVES</div>
				<div id="moveLog"></div>
			</div>
		</div>
		<button onclick="location.reload()">Reset Game</button>
		<script>
			let board = [
				['r','n','b','q','k','b','n','r'], ['p','p','p','p','p','p','p','p'],
				['','','','','','','',''], ['','','','','','','',''],
				['','','','','','','',''], ['','','','','','','',''],
				['P','P','P','P','P','P','P','P'], ['R','N','B','Q','K','B','N','R']
			];

			//const piecesNames = {'P':'Pedone', 'R':'Torre', 'N':'Cavallo', 'B':'Alfiere', 'Q':'Regina', 'K':'Re', 'p':'Pedone', 'r':'Torre', 'n':'Cavallo', 'b':'Alfiere', 'q':'Regina', 'k':'Re'};
			const piecesNames = {'P':'Pawn', 'R':'Rook', 'N':'Knight', 'B':'Bishop', 'Q':'Queen', 'K':'King', 'p':'Pawn', 'r':'Rook', 'n':'Knight', 'b':'Bishop', 'q':'Queen', 'k':'King'};
			const pieces = {'p':'♟', 'r':'♜', 'n':'♞', 'b':'♝', 'q':'♛', 'k':'♚', 'P':'♙', 'R':'♖', 'N':'♘', 'B':'♗', 'Q':'♕', 'K':'♔'};
			let selected = null, legalMoves = [], turn = 'W', lastMove = null;

			function drawBoard(flashSquare = null){
				const boardEl = document.getElementById('board');
				boardEl.innerHTML = '';
				const whiteKingPos = findKing(board, 'W');
				const isWhiteInCheck = isSquareAttacked(board, whiteKingPos.r, whiteKingPos.c, 'B');
				for(let r = 0; r < 8; r++){
					for(let c = 0; c < 8; c++){
						const sq = document.createElement('div');
						sq.className = `square ${(r + c)%2 === 0 ? 'light' : 'dark'}`;
						const p = board[r][c];
						if(p){
							sq.textContent = pieces[p];
							sq.style.color = p === p.toUpperCase() ? "white" : "black";
							if(p === p.toUpperCase()){
								sq.style.textShadow = "0 0 3px black";
							}
						}
						if(lastMove && ((lastMove.fR === r && lastMove.fC === c) || (lastMove.tR === r && lastMove.tC === c))){
							sq.classList.add('last-move');
						}
						if(selected && selected.r === r && selected.c === c){
							sq.classList.add('selected');
						}
						if(p === 'K' && isWhiteInCheck){
							sq.classList.add('in-check');
						}
						if(flashSquare && flashSquare.r === r && flashSquare.c === c){
							sq.classList.add('flash-red');
						}
						const move = legalMoves.find(m => m.r === r && m.c === c);
						if(move){
							if(board[r][c]){
								sq.classList.add('capture-mark');
							}else{
								sq.classList.add('legal-dot');
							}
						}
						sq.onclick = () => handleClick(r, c);
						boardEl.appendChild(sq);
					}
				}
			}

			function findKing(b, color){
				const target = color === 'W' ? 'K' : 'k';
				for(let r = 0; r < 8; r++){
					for(let c = 0; c < 8; c++){
						if(b[r][c] === target){
							return{r, c};
						}
					}
				}
			}

			function isSquareAttacked(b, row, col, attackerColor){
				for(let r = 0; r < 8; r++){
					for(let c = 0; c < 8; c++){
						const p = b[r][c];
						if(!p || (attackerColor === 'W' ? p !== p.toUpperCase() : p !== p.toLowerCase())){
							continue;
						}
						if(getRawMoves(b, r, c).some(m => m.r === row && m.c === col)){
							return true;
						}
					}
				}
				return false;
			}

			function getRawMoves(b, r, c){
				let m = [];
				const p = b[r][c].toLowerCase();
				const isW = b[r][c] === b[r][c].toUpperCase();
				const dirs ={'r': [[1,0],[-1,0],[0,1],[0,-1]], 'b': [[1,1],[1,-1],[-1,1],[-1,-1]], 'q': [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]], 'n': [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]], 'k': [[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]]};
				if(p === 'p'){
					let d = isW ? -1 : 1;
					if(r + d >= 0 && r + d < 8 && !b[r + d][c]){
						m.push({r:r+d, c:c});
						if(((isW && r===6) || (!isW && r===1)) && !b[r + 2*d][c]){
							m.push({r:r + 2*d, c:c});
						}
					}
					for(let dc of [-1,1]){
						let nr = r + d, nc = c + dc;
						if(nr >= 0 && nr < 8 && nc >= 0 && nc < 8 && b[nr][nc]){
							if(isW ? b[nr][nc] === b[nr][nc].toLowerCase() : b[nr][nc] === b[nr][nc].toUpperCase()) m.push({r:nr, c:nc});
						}
					}
				}else if(dirs[p]){
					for(let [dr, dc] of dirs[p]){
						let nr = r + dr, nc = c + dc;
						while(nr >= 0 && nr < 8 && nc >= 0 && nc < 8){
							const targetPiece = b[nr][nc];
							if(!targetPiece){
								m.push({ r: nr, c: nc });
							}else{
								const isEnemy = isW ? (targetPiece === targetPiece.toLowerCase()) : (targetPiece === targetPiece.toUpperCase());
								if(isEnemy){
									m.push({r: nr, c: nc});
								}
								break;
							}
							if(p === 'n' || p === 'k'){
								break;
							}
							nr += dr;
							nc += dc;
						}
					}
				}
				return m;
			}

			function getSafeMoves(r, c){
				const color = board[r][c] === board[r][c].toUpperCase() ? 'W' : 'B';
				return getRawMoves(board, r, c).filter(m => {
					const tmp = board.map(row => [...row]);
					tmp[m.r][m.c] = tmp[r][c];tmp[r][c] = '';
					const k = findKing(tmp, color);
					return !isSquareAttacked(tmp, k.r, k.c, color === 'W' ? 'B' : 'W');
				});
			}

			function logMove(who, piece, from, to, captured){
				const log = document.getElementById('moveLog');
				const coords = String.fromCharCode(97 + to.c) + (8 - to.r);
				let text = `${who}: ${piecesNames[piece]} in ${coords}`;
				if(captured){
					text += ` (Eaten ${piecesNames[captured]})`;
				}
				const div = document.createElement('div');
				div.className = 'log-entry';
				div.textContent = text;
				log.prepend(div);
			}

			function handleClick(r, c){
				if(turn === 'B'){
					return;
				}
				const move = legalMoves.find(m => m.r === r && m.c === c);
				if(move){
					executeMove(selected.r, selected.c, r, c);
					return;
				}
				if(board[r][c] && board[r][c] === board[r][c].toUpperCase()){
					selected ={r, c};
					legalMoves = getSafeMoves(r, c);
				}else{
					selected = null;
					legalMoves = [];
				}
				drawBoard();
			}

			function executeMove_0(fR, fC, tR, tC){
				const p = board[fR][fC];
				const captured = board[tR][tC];
				logMove(turn === 'W' ? "White" : "PC", p,{r:fR, c:fC},{r:tR, c:tC}, captured);
				board[tR][tC] = p;
				board[fR][fC] = '';
				if(p === 'P' && tR === 0){
					board[tR][tC] = 'Q';
				}
				if(p === 'p' && tR === 7){
					board[tR][tC] = 'q';
				}
				lastMove = {fR, fC, tR, tC};
				selected = null;
				legalMoves = [];
				if(captured){
					drawBoard({r: tR, c: tC});
				}else{
					drawBoard();
				}
				if(turn === 'W'){
					turn = 'B';
					document.getElementById('status').textContent = "PC is thinking...";
					setTimeout(pcMove, 800);
				}else{
					turn = 'W';
					document.getElementById('status').textContent = "White has to move.";
				}
			}

			function executeMove(fR, fC, tR, tC) {
				const p = board[fR][fC];
				const captured = board[tR][tC];
				logMove(turn === 'W' ? "White" : "PC", p, { r: fR, c: fC }, { r: tR, c: tC }, captured);
				board[tR][tC] = p;
				board[fR][fC] = '';
				if(p === 'P' && tR === 0){
					board[tR][tC] = 'Q';
				}
				if(p === 'p' && tR === 7){
					board[tR][tC] = 'q';
				}
				lastMove = {fR, fC, tR, tC};
				selected = null;
				legalMoves = [];
				if(captured){
					drawBoard({r: tR, c: tC});
				}else{
					drawBoard();
				}
				if(turn === 'W'){
					turn = 'B';
					document.getElementById('status').textContent = "PC is thinking...";
					setTimeout(pcMove, 800);
				}else{
					turn = 'W';
					let whiteMoves = [];
					for(let r = 0; r < 8; r++){
						for(let c = 0; c < 8; c++){
							if(board[r][c] && board[r][c] === board[r][c].toUpperCase()) {
								whiteMoves = whiteMoves.concat(getSafeMoves(r, c));
							}
						}
					}
					if(whiteMoves.length === 0){
						const whiteKingPos = findKing(board, 'W');
						const isWhiteInCheck = isSquareAttacked(board, whiteKingPos.r, whiteKingPos.c, 'B');
						if(isWhiteInCheck){
							document.getElementById('status').textContent = "CHECKMATE! PC wins!";
						}else{
							document.getElementById('status').textContent = "STALEMATE! It's a draw.";
						}
						turn = 'OVER';
					}else{
						document.getElementById('status').textContent = "White's turn";
					}
				}
			}

			function pcMove() {
				const pieceValues = {'p': 10, 'n': 30, 'b': 30, 'r': 50, 'q': 90, 'k': 900};
				let allMoves = [];
				for(let r = 0; r < 8; r++){
					for(let c = 0; c < 8; c++){
						if(board[r][c] && board[r][c] === board[r][c].toLowerCase()){
							const moves = getSafeMoves(r, c);
							const movingPiece = board[r][c].toLowerCase();
							moves.forEach(m => {
								let weight = Math.random()*2;
								const targetPiece = board[m.r][m.c];
								if(targetPiece){
									const capturedValue = pieceValues[targetPiece.toLowerCase()];
									weight += capturedValue;
									const tmpBoard = board.map(row => [...row]);
									tmpBoard[m.r][m.c] = tmpBoard[r][c];
									tmpBoard[r][c] = '';
									if(isSquareAttacked(tmpBoard, m.r, m.c, 'W')){
										weight -= pieceValues[movingPiece];
									}
								}
								allMoves.push({ fR: r, fC: c, tR: m.r, tC: m.c, weight });
							});
						}
					}
				}
				if(allMoves.length === 0){
					const blackKingPos = findKing(board, 'B');
					const isBlackInCheck = isSquareAttacked(board, blackKingPos.r, blackKingPos.c, 'W');
					if(isBlackInCheck){
						document.getElementById('status').textContent = "CHECKMATE! You win!";
					}else{
						document.getElementById('status').textContent = "STALEMATE! There are no legal moves.";
					}
					return;
				}
				allMoves.sort((a, b) => b.weight - a.weight);
				const bestMove = allMoves[0];
				executeMove(bestMove.fR, bestMove.fC, bestMove.tR, bestMove.tC);
			}

			function toggleLog(){
				const logContainer = document.getElementById('logContainer');
				const checkBox = document.getElementById('toggleLog');
				logContainer.style.display = checkBox.checked ? 'block' : 'none';
			}

			drawBoard();
		</script>
	</body>
</html>