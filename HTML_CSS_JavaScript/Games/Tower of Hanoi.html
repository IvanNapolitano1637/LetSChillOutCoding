<!DOCTYPE HTML>
<html lang="en"><!--G03#008 - Luca - Tower of Hanoi-->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Tower of Hanoi</title>
		<style>
			body{
				font-family: sans-serif; 
				transition: background 0.5s; 
				text-align: center; 
				overflow-x: hidden; 
				display: flex;
				flex-direction: column;
				align-items: center;
				margin: 0;
				padding: 10px;
				min-height: 100vh;
				box-sizing: border-box;
			}
			canvas{
				background: transparent;
				cursor: pointer; 
				display: block;
				margin: 20px auto;
				max-width: 100%; 
				height: auto; 
				border-radius: 8px;
				align-self: center;
				image-rendering: auto;
			}
			.controls{
				margin-top: 20px; 
				display: flex; 
				flex-wrap: wrap; 
				justify-content: center; 
				gap: 10px; 
				width: 100%;
			}
			.versions-panel{
				margin-top: 20px; 
				padding: 10px; 
				border: 1px dashed #666; 
				display: inline-block; 
			}
			@media screen and(max-width: 600px){
				.mobile-rotate{transform: rotate(90deg); }
			}
		</style>
	</head>

	<body>

		<canvas id="universe" onclick="select()"></canvas>

		<div class="controls">
			<select id="disksNumber" onchange="changeDiskCount()"></select>
			<button type="button" onclick="resetGame()">Restart</button>
			<button type="button" onclick="animatedSolving()">How To(Demo)</button>
		</div>

		<div class="versions-panel" id="versions">
			<label><input type="radio" name="vPage" value="1" onclick="changeVersion(1)" checked> Version 1</label>
			<label><input type="radio" name="vPage" value="2" onclick="changeVersion(2)"> Version 2</label>
		</div>

		<script>
			//I'm not sure aboute step duration, "MILLISECONDS" const value.
			let version = 1;
			const DESKTOP = !(/Mobi|Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i).test(navigator.userAgent);
			const UNIT = DESKTOP ? 9 : 6;
			const H_SPACE = 8*UNIT, V_SPACE = H_SPACE;
			const BASE_HEIGHT = 2*UNIT, DISK_INCREASE = 2*UNIT, DISK_BASE_LENGTH = 6*UNIT;
			const WIDTH = 32*UNIT, PAGE_WIDTH = 4*UNIT, LATERAL_MARGIN = 2*UNIT;
			const UPPER_MARGIN = 4*UNIT, UPPER_PAGE_MARGIN = 2*UNIT, LOWER_MARGIN = 2*UNIT;
			const PAGE_LENGTH = WIDTH - 2*LATERAL_MARGIN;
			const TOTAL_WIDTH = 2*(4*UNIT) + 2*H_SPACE + 3*WIDTH;
			const BROWN = "#905000", ORANGE = "#ffcc00";//const lightYellow = "#ffff88";
			const COLORS_1 = ["#00ffff","#ff0000","#ff8000","#ffff00","#00ff00","#0000ff","#ff00ff"];
			const COLORS_2 = ["#ffffff","#00ffff","#ff0000","#ff8000","#ffff00","#00ff00","#0000ff","#ff00ff","#006400","#000000"];

			let numberOfDisks = 4;
			let universe, context, nIntervId = null;
			let towers = [[], [], []], selectedTower = [false, false, false];
			let activeTower = -1, wan = false, demo = false, steps = "", step = 0;
			let cursorX = 0, cursorY = 0;
			let maximumNumberOfDisks, disksHeight, pink, gray, colors, totalHeight, pegHeight;
			window.onload = initGame;

			function initGame(){
				universe = document.getElementById("universe");
				context = universe.getContext("2d");
				document.onmousemove =(e) => {
					const rect = universe.getBoundingClientRect();
					cursorX = e.clientX - rect.left;
					cursorY = e.clientY - rect.top;
				};
				resetGame();
			}

			function resetGame(){
				if(nIntervId){
					clearInterval(nIntervId);
					nIntervId = null;
				}

				maximumNumberOfDisks =(version === 1) ? 7 : 10;
				disksHeight =(version === 1) ? 6*UNIT : 4*UNIT;
				pink =(version === 1) ? "#ffcccc" : "#ff8888";
				//gray =(version === 1) ? "#444444" : "#888888";
				gray =(version === 1) ? "rgba(0,0,0,0.05)" : "rgba(0,0,0,0.1)";
				colors =(version === 1) ? COLORS_1 : COLORS_2;
				
				pegHeight = numberOfDisks*disksHeight + UPPER_PAGE_MARGIN;
				totalHeight = V_SPACE + UPPER_MARGIN + pegHeight + BASE_HEIGHT + LOWER_MARGIN;
				
				document.body.style.background = pink;
				universe.width = TOTAL_WIDTH;
				universe.height = totalHeight;

				wan = false;
				demo = false;
				activeTower = -1;
				towers = [[], [], []];
				selectedTower = [false, false, false];
				for(let i = 0; i < numberOfDisks; i++){
					towers[0][i] = numberOfDisks - i - 1;
					towers[1][i] = -1;
					towers[2][i] = -1;
				}

				const select = document.getElementById("disksNumber");
				select.innerHTML = "";
				for(let i = 1; i <= maximumNumberOfDisks; i++){
					let opt = document.createElement("option");
					opt.value = i; opt.text = "Level " + i;
					if(i === numberOfDisks){
						opt.selected = true;
					}
					select.add(opt);
				}

				steps = calculateSteps(numberOfDisks);
				step = 0;

				drawAll();
			}

			function changeDiskCount(){
				numberOfDisks = parseInt(document.getElementById("disksNumber").value);
				resetGame();
			}

			function changeVersion(v){
				version = v;
				numberOfDisks =(v === 1 && numberOfDisks > 7) ? 7 : numberOfDisks;
				resetGame();
			}

			function select(){
				if(wan){
					return;
				}
				
				let towerIdx = -1;
				const clickX = cursorX;
				for(let i = 0; i < 3; i++){
					let xStart = i*WIDTH +(i + 1)*H_SPACE;
					if(clickX >= xStart && clickX <= xStart + WIDTH){
						towerIdx = i;
						break;
					}
				}

				if(towerIdx === -1){
					return;
				}

				if(activeTower === -1){
					if(getLastDiskIndex(towerIdx) !== -1){
						activeTower = towerIdx;
						selectedTower[towerIdx] = true;
					}
				}else{
					if(activeTower === towerIdx){
						selectedTower[towerIdx] = false;
						activeTower = -1;
					}else{
						moveDisk(activeTower, towerIdx);
						selectedTower[activeTower] = false;
						activeTower = -1;
					}
				}
				drawAll();
				checkWin();
			}

			function moveDisk(from, to){
				let fromIdx = getLastDiskIndex(from);
				let toIdx = getLastDiskIndex(to);
				let diskToMove = towers[from][fromIdx];

				if(toIdx === -1 || diskToMove < towers[to][toIdx]){
					towers[from][fromIdx] = -1;
					towers[to][toIdx + 1] = diskToMove;
				}
			}

			function getLastDiskIndex(t){
				let idx = numberOfDisks - 1;
				while(idx >= 0 && towers[t][idx] === -1){
					idx--;
				}
				return idx;
			}

			function checkWin(){
				if(towers[2][numberOfDisks-1] !== -1){
					wan = true;
					document.body.style.background = "#00FF00";
					if(!demo){
						setTimeout(() => alert("Complimenti! Hai vinto!"), 200);
					}
				}
			}

			function drawAll(){
				context.clearRect(0, 0, universe.width, universe.height);
				for(let i = 0; i < 3; i++){
					drawTower(i);
				}
			}

			function drawTower(idx){
				let x0 = idx*WIDTH +(idx + 1)*H_SPACE;
				context.fillStyle = selectedTower[idx] ? ORANGE : gray;
				context.fillRect(x0, V_SPACE, WIDTH, totalHeight - V_SPACE);
				context.fillStyle = BROWN;
				context.fillRect(x0 +(WIDTH - PAGE_WIDTH)/2, V_SPACE + UPPER_MARGIN, PAGE_WIDTH, pegHeight);
				context.fillRect(x0 + LATERAL_MARGIN, V_SPACE + UPPER_MARGIN + pegHeight, PAGE_LENGTH, BASE_HEIGHT);
				for(let i = 0; i < numberOfDisks; i++){
					let diskValue = towers[idx][i];
					if(diskValue >= 0){
						let level = numberOfDisks - i - 1;
						drawDisk(idx, level, diskValue);
					}
				}
			}

			function drawDisk(tIdx, level, dSize){
				context.fillStyle = colors[dSize];
				let w = DISK_BASE_LENGTH + dSize*DISK_INCREASE;
				let x = tIdx*WIDTH +(tIdx + 1)*H_SPACE +(WIDTH - w)/2;
				let y = V_SPACE + level*disksHeight + UPPER_MARGIN + UPPER_PAGE_MARGIN;
				context.fillRect(x, y, w, disksHeight - 1);
				context.beginPath();
				context.arc(x, y + disksHeight/2, disksHeight/2, 0, Math.PI*2);
				context.arc(x + w, y + disksHeight/2, disksHeight/2, 0, Math.PI*2);
				context.fill();
			}

			function calculateSteps(n){
				let moves = [];
				function hanoi(num, from, to, aux){
					if(num === 1){moves.push({f: from, t: to}); return; }
					hanoi(num - 1, from, aux, to);
					moves.push({f: from, t: to});
					hanoi(num - 1, aux, to, from);
				}
				hanoi(n, 0, 2, 1);
				return moves;
			}

			function animatedSolving(){
				resetGame();
				demo = true;
				nIntervId = setInterval(() => {
					if(step < steps.length){
						let m = steps[step];
						moveDisk(m.f, m.t);
						drawAll();
						checkWin();
						step++;
					}else{
						clearInterval(nIntervId);
					}
				}, 500);
			}

		</script>
	</body>
</html>