<!DOCTYPE html>
<html lang="en"><!--G09#019 - Samuele - Backgammon-->
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Backgammon</title>
	<style>
		:root{
			--wood: #3e2723;
			--felt: #1b5e20;
			--accent: #f1c40f;
		}
		body{
			background: #121212;
			font-family: sans-serif;
			display: flex;
			flex-direction: column;
			align-items: center;
			color: white;
			margin: 0;
			padding: 10px;
			-webkit-tap-highlight-color: transparent;
			user-select: none;
			touch-action: manipulation;
		}
		canvas{
			background: var(--felt);
			border: 10px solid var(--wood);
			border-radius: 12px;
			max-width: 100%;
			height: auto;
			cursor: pointer;
		}
		.panel{
			display: flex;
			width: 100%;
			max-width: 660px;
			flex-wrap: wrap; 
			justify-content: center;
			align-items: center;
			background: #252525;
			padding: 15px;
			border-radius: 12px;
			margin-top: 10px;
			box-sizing: border-box;
			gap: 10px;
		}
		#dice-ui{
			font-size: 2em;
			min-width: 50px;
			text-align: center;
		}
		.btn{
			padding: 12px;
			font-size: 0.9em;
			cursor: pointer;
			background: #c0392b;
			border: none;
			color: white;
			border-radius: 6px;
			font-weight: bold;
			flex: 1;
			min-width: 80px;
		}
		.btn-undo{
			background: #2980b9;
		}
		.btn:disabled{
			opacity: 0.3;
		}
		.score-container{
			width: 100%;
			display: flex;
			justify-content: space-around;
			margin-top: 5px;
			font-size: 0.9em;
			border-top: 1px solid #444;
			padding-top: 10px;
		}
		@media (min-width: 850px){
			#game-container{
				display: flex;
				flex-direction: row;
				align-items: flex-start;
				gap: 20px;
			}
			.panel{
				flex-direction: column;
				width: 180px;
				flex-wrap: nowrap;
				margin-top: 0;
				height: 540px;
				justify-content: flex-start;
			}
			.btn{
				width: 100%;
				flex: 0 0 auto;
				margin-bottom: 5px;
			}
			#dice-ui{
				margin-bottom: 20px;
				font-size: 3em;
			}
			.score-container{
				flex-direction: column;
				align-items: center;
				gap: 10px;
				margin-top: auto;
				border-top: none;
			}
		}
	</style>
	</head>
	<body>
		<div id="status" style="margin-bottom:10px">Roll the dice to play</div>
		<div id="game-container">
			<canvas id="board" width="660" height="540"></canvas>
			<div class="panel">
				<div id="dice-ui" style="font-size:3em; margin-bottom:10px">ðŸŽ²</div>
				<button id="roll-btn" class="btn">ROLL THE DICE</button>
				<button id="undo-btn" class="btn btn-undo" disabled>UNDO</button>
				<div style="margin-top:20px; text-align:center">
					âšª YOU: <span id="w-off">0</span>/15<br/>
					âš« AI: <span id="b-off">0</span>/15
				</div>
			</div>
		</div>
		<script>
			const canvas = document.getElementById('board');
			const ctx = canvas.getContext('2d');
			const rollBtn = document.getElementById('roll-btn');
			const undoBtn = document.getElementById('undo-btn');
			const BW = 660, BH = 540, TW = 46, TH = 200, PR = 18;
			let history = [];
			let game ={board: [2, 0, 0, 0, 0, -5, 0, -3, 0, 0, 0, 5, -5, 0, 0, 0, 3, 0, 5, 0, 0, 0, 0, -2], bar:{ 1: 0, "-1": 0 }, off:{ 1: 0, "-1": 0 }, turn: 1, dice: [], moves: [], selected: null };

			function getX(i){
				let col = i < 12 ? 11 - i : i - 12;
				let x = col*TW + 32;
				if(col >= 6){
					x += 45;
				}
				return x;
			}

			function draw(){
				ctx.fillStyle = "#3e2723";
				ctx.fillRect(0, 0, BW, BH);
				ctx.fillStyle = "#1b5e20";
				ctx.fillRect(10, 10, BW - 20, BH - 20);
				for(let i = 0; i < 24; i++){
					ctx.fillStyle = (i % 2 === 0) ? "#d7ccc8" : "#8d6e63";
					let x = getX(i), y = i >= 12 ? 10 : BH - 10;
					ctx.beginPath();
					ctx.moveTo(x, y);
					ctx.lineTo(x + TW, y);
					ctx.lineTo(x + TW/2, i >= 12 ? TH + 10 : BH - TH - 10);
					ctx.fill();
					let n = game.board[i], count = Math.abs(n), col = n > 0 ? "#fff" : "#222";
					for(let j = 0; j < count; j++){
						ctx.fillStyle = col;
						ctx.beginPath();
						ctx.arc(x + TW/2, i >= 12 ? (j*32 + 35) : (BH - j*32 - 35), PR, 0, 7);
						ctx.fill();
						ctx.stroke();
						if(game.selected === i && j === count - 1){
							ctx.strokeStyle = "#f1c40f";
							ctx.lineWidth = 3;
							ctx.stroke();
							ctx.strokeStyle = "#000";
							ctx.lineWidth = 1;
						}
					}
				}
				document.getElementById('w-off').innerText = game.off[1];
				document.getElementById('b-off').innerText = game.off[-1];
			}

			rollBtn.onclick = () => {
				if(game.turn === 1 && game.moves.length === 0){
					history = [];
					rollDice();
				}
			};

			undoBtn.onclick = () => {
				if(history.length > 0){
					game = JSON.parse(history.pop());
					undoBtn.disabled = history.length === 0;
					draw();
				}
			};

			function rollDice(){
				game.dice = [Math.floor(Math.random()*6) + 1, Math.floor(Math.random()*6) + 1];
				game.moves = (game.dice[0] === game.dice[1]) ? [game.dice[0], game.dice[0], game.dice[0], game.dice[0]] : [...game.dice];
				document.getElementById('dice-ui').innerText = game.dice.join(" ");
				if(game.turn === -1){
					document.getElementById('status').innerText = "AI is playing...";
					setTimeout(aiPlay, 1000);
				}else{
					document.getElementById('status').innerText = "You to move!";
				}
				draw();
			}

			canvas.onclick = (e) => {
				if(game.turn !== 1 || game.moves.length === 0){
					return;
				}
				const rect = canvas.getBoundingClientRect();
				const x = (e.clientX - rect.left)*(BW/rect.width);
				const y = (e.clientY - rect.top)*(BH/rect.height);
				let clicked = -1;
				for(let i = 0; i < 24; i++){
					let px = getX(i);
					if(x >= px && x <= px + TW){
						clicked = i;
					}
				}
				if(x > BW - 60){
					clicked = 99;
				}
				if(game.selected === null){
					if(game.bar[1] > 0){
						game.selected = "bar";
					}else if(clicked !== -1 && game.board[clicked] > 0){
						game.selected = clicked;
					}
				}else{
					history.push(JSON.stringify(game));
					undoBtn.disabled = false;
					if(!executeMove(game.selected, clicked)){
						history.pop();
						undoBtn.disabled = history.length === 0;
					}
					game.selected = null;
				}
				draw();
			};

			function executeMove(f, t){
				let mIdx = game.moves.findIndex(m => {
					let target = (f === "bar") ? m - 1 : f + m;
					if(t === 99 && f >= 18 && target >= 24){
						return true;
					}
					return target === t;
				});
				if(mIdx === -1){
					return false;
				}
				if(t === 99){
					game.board[f]--; game.off[1]++;
				}else{
					if(game.board[t] < -1){
						return false;
					}
					if(game.board[t] === -1){
						game.board[t] = 0;
						game.bar[-1]++;
					}
					if(f === "bar"){
						game.bar[1]--;
					}else{
						game.board[f]--;
					}
					game.board[t]++;
				}
				game.moves.splice(mIdx, 1);
				if(game.moves.length === 0){
					game.turn = -1;
					setTimeout(rollDice, 800);
				}
				return true;
			}

			function aiPlay(){
				if(game.moves.length > 0){
					let moved = false;
					for(let m of game.moves){
						for(let i = 23; i >= 0; i--){
							if(game.board[i] < 0){
								let target = i - m;
								if(target >= 0 && game.board[target] <= 1){
									if(game.board[target] === 1){
										game.board[target] = 0;
										game.bar[1]++;
									}
									game.board[i]++;
									game.board[target]--;
									game.moves.splice(game.moves.indexOf(m), 1);
									moved = true; break;
								}
							}
						}
						if(moved){
							break;
						}
					}
					if(moved){
						draw();
						setTimeout(aiPlay, 600);
					}else{
						game.moves = [];
						game.turn = 1;
						document.getElementById('status').innerText = "You to move!";
						draw();
					}
				}else{
					game.turn = 1;
					document.getElementById('status').innerText = "You to move!";
					draw();
				}
			}

			draw();
		</script>
	</body>
</html>